# Integra√ß√£o do Supabase - AiLun Saude

Este documento descreve como o Supabase est√° integrado no projeto AiLun Saude e como utilizar os servi√ßos dispon√≠veis.

## üìã √çndice

1. [Configura√ß√£o](#configura√ß√£o)
2. [Autentica√ß√£o](#autentica√ß√£o)
3. [Banco de Dados](#banco-de-dados)
4. [Storage](#storage)
5. [Realtime](#realtime)
6. [Hooks Personalizados](#hooks-personalizados)
7. [Exemplos de Uso](#exemplos-de-uso)

---

## üîß Configura√ß√£o

### Credenciais

As credenciais do Supabase est√£o configuradas no arquivo `.env`:

```env
EXPO_PUBLIC_SUPABASE_URL=https://bmtieinegditdeijyslu.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Cliente Supabase

O cliente est√° inicializado em `services/supabase.ts`:

```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.EXPO_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

---

## üîê Autentica√ß√£o

### Servi√ßos Dispon√≠veis

O arquivo `services/auth.ts` fornece fun√ß√µes prontas para autentica√ß√£o:

#### Registro de Usu√°rio

```typescript
import { signUp } from '../services/auth';

const handleSignUp = async () => {
  const result = await signUp('usuario@email.com', 'senha123');
  
  if (result.success) {
    console.log('Usu√°rio registrado:', result.data);
  } else {
    console.error('Erro:', result.error);
  }
};
```

#### Login

```typescript
import { signIn } from '../services/auth';

const handleSignIn = async () => {
  const result = await signIn('usuario@email.com', 'senha123');
  
  if (result.success) {
    console.log('Login realizado:', result.data);
  } else {
    console.error('Erro:', result.error);
  }
};
```

#### Logout

```typescript
import { signOut } from '../services/auth';

const handleSignOut = async () => {
  await signOut();
};
```

#### Resetar Senha

```typescript
import { resetPassword } from '../services/auth';

const handleResetPassword = async () => {
  const result = await resetPassword('usuario@email.com');
  
  if (result.success) {
    console.log('Email de recupera√ß√£o enviado');
  }
};
```

### Hook useAuth

Para facilitar o uso em componentes React, utilize o hook `useAuth`:

```typescript
import { useAuth } from '../hooks/useAuth';

function MyComponent() {
  const { user, session, loading, signIn, signOut } = useAuth();

  if (loading) {
    return <Text>Carregando...</Text>;
  }

  if (!user) {
    return <LoginScreen onSignIn={signIn} />;
  }

  return (
    <View>
      <Text>Bem-vindo, {user.email}</Text>
      <Button title="Sair" onPress={signOut} />
    </View>
  );
}
```

---

## üóÑÔ∏è Banco de Dados

### Estrutura de Tabelas

O projeto utiliza as seguintes tabelas principais:

- **user_profiles**: Perfil do usu√°rio
- **health_info**: Informa√ß√µes de sa√∫de
- **emergency_contacts**: Contatos de emerg√™ncia
- **user_preferences**: Prefer√™ncias do usu√°rio
- **consultation_logs**: Hist√≥rico de consultas
- **active_sessions**: Sess√µes ativas
- **consultation_queue**: Fila de consultas
- **system_notifications**: Notifica√ß√µes do sistema

### Opera√ß√µes CRUD

O arquivo `services/database.ts` fornece fun√ß√µes para todas as opera√ß√µes:

#### Perfil do Usu√°rio

```typescript
import { getUserProfile, upsertUserProfile } from '../services/database';

// Buscar perfil
const profile = await getUserProfile(userId);

// Atualizar perfil
const result = await upsertUserProfile(userId, {
  full_name: 'Jo√£o Silva',
  phone: '(11) 98765-4321',
  birth_date: '1990-01-15',
});
```

#### Informa√ß√µes de Sa√∫de

```typescript
import { getHealthInfo, upsertHealthInfo } from '../services/database';

// Salvar informa√ß√µes de sa√∫de
const result = await upsertHealthInfo(userId, {
  weight: 75,
  height: 175,
  blood_type: 'O+',
  allergies: 'Penicilina',
  medications: 'Losartana 50mg',
});
```

#### Contatos de Emerg√™ncia

```typescript
import { 
  addEmergencyContact, 
  getEmergencyContacts, 
  removeEmergencyContact 
} from '../services/database';

// Adicionar contato
await addEmergencyContact(userId, {
  name: 'Maria Silva',
  phone: '(11) 91234-5678',
});

// Listar contatos
const contacts = await getEmergencyContacts(userId);

// Remover contato
await removeEmergencyContact(contactId);
```

---

## üìÅ Storage

### Upload de Arquivos

O arquivo `services/storage.ts` fornece fun√ß√µes para gerenciar arquivos:

#### Upload de Imagem de Perfil

```typescript
import { uploadProfileImage } from '../services/storage';
import * as ImagePicker from 'expo-image-picker';

const handleUploadImage = async () => {
  // Selecionar imagem
  const result = await ImagePicker.launchImageLibraryAsync({
    mediaTypes: ImagePicker.MediaTypeOptions.Images,
    allowsEditing: true,
    aspect: [1, 1],
    quality: 0.8,
  });

  if (!result.canceled) {
    const upload = await uploadProfileImage(userId, result.assets[0].uri);
    
    if (upload.success) {
      console.log('URL da imagem:', upload.url);
    }
  }
};
```

#### Upload de Documento M√©dico

```typescript
import { uploadMedicalDocument } from '../services/storage';
import * as DocumentPicker from 'expo-document-picker';

const handleUploadDocument = async () => {
  const result = await DocumentPicker.getDocumentAsync({
    type: 'application/pdf',
  });

  if (result.type === 'success') {
    const upload = await uploadMedicalDocument(
      userId, 
      result.uri, 
      result.name
    );
    
    if (upload.success) {
      console.log('Documento salvo:', upload.path);
    }
  }
};
```

### Download e Acesso a Arquivos

```typescript
import { getPublicUrl, getSignedUrl, downloadFile } from '../services/storage';

// URL p√∫blica (para buckets p√∫blicos)
const publicUrl = getPublicUrl('avatars', `${userId}/profile.jpg`);

// URL assinada (para buckets privados, expira em 1 hora)
const signedUrl = await getSignedUrl('medical-documents', filePath, 3600);

// Download direto
const file = await downloadFile('medical-documents', filePath);
```

---

## ‚ö° Realtime

### Inscrever-se para Mudan√ßas em Tempo Real

```typescript
import { subscribeToUserChanges } from '../services/database';

useEffect(() => {
  const subscription = subscribeToUserChanges(userId, (payload) => {
    console.log('Mudan√ßa detectada:', payload);
    // Atualizar estado do componente
  });

  return () => {
    subscription.unsubscribe();
  };
}, [userId]);
```

### Exemplo: Chat em Tempo Real

```typescript
import { supabase } from '../services/supabase';

// Inscrever-se para novas mensagens
const channel = supabase
  .channel('messages')
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'messages',
    },
    (payload) => {
      console.log('Nova mensagem:', payload.new);
    }
  )
  .subscribe();

// Enviar mensagem
await supabase.from('messages').insert({
  user_id: userId,
  content: 'Ol√°!',
});
```

---

## üé£ Hooks Personalizados

### useAuth

Gerencia autentica√ß√£o e sess√£o do usu√°rio.

```typescript
const { user, session, loading, signIn, signUp, signOut } = useAuth();
```

### Criar Hooks Personalizados

Voc√™ pode criar hooks para outras funcionalidades:

```typescript
// hooks/useUserProfile.ts
import { useState, useEffect } from 'react';
import { getUserProfile } from '../services/database';

export const useUserProfile = (userId: string) => {
  const [profile, setProfile] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchProfile = async () => {
      const result = await getUserProfile(userId);
      if (result.success) {
        setProfile(result.data);
      }
      setLoading(false);
    };

    fetchProfile();
  }, [userId]);

  return { profile, loading };
};
```

---

## üí° Exemplos de Uso

### Tela de Login Completa

```typescript
import React, { useState } from 'react';
import { View, TextInput, Button, Text } from 'react-native';
import { useAuth } from '../hooks/useAuth';

export default function LoginScreen() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const { signIn, loading } = useAuth();

  const handleLogin = async () => {
    const result = await signIn(email, password);
    
    if (!result.success) {
      alert(result.error);
    }
  };

  return (
    <View>
      <TextInput
        placeholder="Email"
        value={email}
        onChangeText={setEmail}
        autoCapitalize="none"
      />
      <TextInput
        placeholder="Senha"
        value={password}
        onChangeText={setPassword}
        secureTextEntry
      />
      <Button 
        title={loading ? "Carregando..." : "Entrar"} 
        onPress={handleLogin}
        disabled={loading}
      />
    </View>
  );
}
```

### Tela de Perfil com Upload de Foto

```typescript
import React, { useEffect, useState } from 'react';
import { View, Image, Button } from 'react-native';
import { useAuth } from '../hooks/useAuth';
import { getUserProfile } from '../services/database';
import { uploadProfileImage } from '../services/storage';
import * as ImagePicker from 'expo-image-picker';

export default function ProfileScreen() {
  const { user } = useAuth();
  const [profile, setProfile] = useState(null);
  const [avatarUrl, setAvatarUrl] = useState(null);

  useEffect(() => {
    if (user) {
      loadProfile();
    }
  }, [user]);

  const loadProfile = async () => {
    const result = await getUserProfile(user.id);
    if (result.success) {
      setProfile(result.data);
      setAvatarUrl(result.data.avatar_url);
    }
  };

  const handleUploadAvatar = async () => {
    const result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.Images,
      allowsEditing: true,
      aspect: [1, 1],
      quality: 0.8,
    });

    if (!result.canceled) {
      const upload = await uploadProfileImage(user.id, result.assets[0].uri);
      
      if (upload.success) {
        setAvatarUrl(upload.url);
      }
    }
  };

  return (
    <View>
      {avatarUrl && (
        <Image 
          source={{ uri: avatarUrl }} 
          style={{ width: 100, height: 100, borderRadius: 50 }}
        />
      )}
      <Button title="Alterar Foto" onPress={handleUploadAvatar} />
    </View>
  );
}
```

---

## üîí Seguran√ßa

### Row Level Security (RLS)

Certifique-se de que as pol√≠ticas RLS est√£o configuradas no Supabase para proteger os dados:

```sql
-- Exemplo: Usu√°rios s√≥ podem ver seus pr√≥prios dados
CREATE POLICY "Users can view own profile"
  ON user_profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON user_profiles FOR UPDATE
  USING (auth.uid() = id);
```

### Valida√ß√£o de Dados

Sempre valide os dados antes de enviar ao Supabase:

```typescript
const validateEmail = (email: string) => {
  const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return regex.test(email);
};

const validatePassword = (password: string) => {
  return password.length >= 6;
};
```

---

## üìö Recursos Adicionais

- [Documenta√ß√£o Oficial do Supabase](https://supabase.com/docs)
- [Supabase JS Client](https://supabase.com/docs/reference/javascript/introduction)
- [Expo + Supabase](https://supabase.com/docs/guides/getting-started/tutorials/with-expo-react-native)

---

## üÜò Suporte

Para d√∫vidas ou problemas com a integra√ß√£o do Supabase, consulte:

- Dashboard do Supabase: https://app.supabase.com
- Logs do projeto: https://app.supabase.com/project/bmtieinegditdeijyslu/logs

---

**Desenvolvido por AiLun Tecnologia**  
CNPJ: 60.740.536/0001-75  
Email: contato@ailun.com.br

